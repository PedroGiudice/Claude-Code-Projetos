# Traefik Dynamic Configuration for External Services
# This file configures routers for services outside Docker Compose

http:
  routers:
    # Text Extractor HTTP - For Tauri app via Tailscale
    text-http:
      rule: "PathPrefix(`/api/text`)"
      entryPoints:
        - web
      priority: 10
      service: text-extractor
      middlewares:
        - text-strip
        - text-buffering

    # Ollama API - For HotCocoa personalization
    ollama:
      rule: "PathPrefix(`/api/ollama`)"
      entryPoints:
        - websecure
      priority: 15
      service: ollama
      middlewares:
        - ollama-strip
        - ollama-auth
      tls:
        certResolver: letsencrypt

  middlewares:
    # Text Extractor middlewares
    text-strip:
      stripPrefix:
        prefixes:
          - "/api/text"

    text-buffering:
      buffering:
        maxRequestBodyBytes: 104857600

    # Global Basic Auth for protected routes
    auth:
      basicAuth:
        usersFile: "/etc/traefik/.htpasswd"

    ollama-strip:
      stripPrefix:
        prefixes:
          - "/api/ollama"

    ollama-auth:
      basicAuth:
        users:
          - "hotcocoa:$apr1$VbOqcKRh$nTLOfydOQFwadT.2xtsRY1"

  services:
    text-extractor:
      loadBalancer:
        servers:
          - url: "http://10.89.0.57:8001"

    ollama:
      loadBalancer:
        servers:
          - url: "http://172.18.0.1:11434"
