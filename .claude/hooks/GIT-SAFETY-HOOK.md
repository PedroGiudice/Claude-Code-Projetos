# Git Safety Hook - Auto-Save Uncommitted Changes

**Status:** âœ… Active (SessionEnd hook)
**Version:** 1.0.0
**Created:** 2025-11-17

## Overview

Automatic safety mechanism that saves uncommitted changes to a timestamped branch when a Claude Code session ends after 2.5+ hours without commits.

**Problem it solves:** Prevents loss of work when you forget to commit before closing Claude Code (like what happened today).

## How It Works

### Trigger
- Runs automatically on **SessionEnd** (when Claude Code session closes)
- Does NOT force sessions to end - purely reactive

### Logic Flow

```
Session Ends
    â†“
Are there uncommitted changes? â†’ NO â†’ Skip (exit gracefully)
    â†“ YES
How long since last commit? â†’ < 2.5h â†’ Skip (too early)
    â†“ â‰¥ 2.5h
Is repo in conflict state? â†’ YES â†’ Skip (unsafe)
    â†“ NO
Create safety branch: auto-save/session-{timestamp}
    â†“
Commit all changes with detailed message
    â†“
Return to original branch
    â†“
âœ… Done
```

### Session Time Tracking

Uses existing `legal-braniac-session.json` created by SessionStart hooks:

```json
{
  "sessionStart": 1763427938081,  // milliseconds since epoch
  "startTime": 1763427938081
}
```

Fallback: If no session file, uses last commit timestamp.

## Safety Features

### Never Touches Main
- Creates new timestamped branches: `auto-save/session-2025-11-17T22-18-18`
- Original branch remains untouched
- You review and merge manually

### Edge Case Handling
- **Clean repo** â†’ Skips gracefully
- **Merge/rebase in progress** â†’ Skips (unsafe to commit)
- **Detached HEAD** â†’ Skips (unsafe state)
- **Short session** â†’ Skips (< 2.5h threshold)

### Detailed Commit Messages

```
chore: auto-save session changes (3.2h elapsed)

Session ended with uncommitted changes after 3.2 hours.
Auto-saved to safety branch for review.

Branch: main â†’ auto-save/session-2025-11-17T22-18-18
Timestamp: 2025-11-18T01:18:19.052Z

âš ï¸ This is an automatic safety commit. Review changes before merging.

ðŸ¤– Generated by session-end-git-safety hook
```

## Configuration

### Environment Variables

```bash
# Enable/disable hook (default: enabled)
export GIT_SAFETY_ENABLED=true

# Time threshold in hours (default: 2.5)
export GIT_SAFETY_THRESHOLD_HOURS=2.5

# Branch name prefix (default: auto-save)
export GIT_SAFETY_BRANCH_PREFIX=auto-save
```

### Disable Temporarily

```bash
# For current session
export GIT_SAFETY_ENABLED=false

# Or edit .claude/settings.json and remove SessionEnd hook
```

## Usage Examples

### Scenario 1: Forgot to Commit (Normal Case)

```bash
# You work for 3 hours, make changes, forget to commit
# Close Claude Code
# â†’ Hook automatically:
#   - Creates: auto-save/session-2025-11-17T22-18-18
#   - Commits all changes
#   - Returns you to main (clean)

# Next session, review what was saved:
git log auto-save/session-2025-11-17T22-18-18 -1 --stat

# If changes look good, merge:
git merge auto-save/session-2025-11-17T22-18-18

# Or cherry-pick specific files:
git checkout auto-save/session-2025-11-17T22-18-18 -- path/to/file.js
git commit -m "feat: add feature from auto-save"

# Clean up safety branch:
git branch -d auto-save/session-2025-11-17T22-18-18
```

### Scenario 2: Multiple Auto-Saves (Long Project)

```bash
# Over a week, you accumulate several auto-save branches:
git branch --list "auto-save/*"
# auto-save/session-2025-11-17T22-18-18
# auto-save/session-2025-11-18T14-30-45
# auto-save/session-2025-11-19T09-12-33

# Review each one:
for branch in $(git branch --list "auto-save/*" | sed 's/*//' | xargs); do
  echo "=== $branch ==="
  git log $branch -1 --oneline
done

# Merge the ones you want, delete the rest:
git merge auto-save/session-2025-11-18T14-30-45
git branch -d auto-save/session-2025-11-17T22-18-18
git branch -d auto-save/session-2025-11-19T09-12-33
```

### Scenario 3: Manual Testing

```bash
# Test hook manually (forces trigger with low threshold):
GIT_SAFETY_THRESHOLD_HOURS=0.1 node .claude/hooks/session-end-git-safety.js

# Check what would happen without actually running:
git status --porcelain  # Shows uncommitted changes
git log -1 --format=%ct # Shows last commit timestamp (Unix seconds)

# Calculate elapsed hours manually:
echo "scale=2; ($(date +%s) - $(git log -1 --format=%ct)) / 3600" | bc
```

### Scenario 4: Clean Repo (Nothing to Save)

```bash
# All changes already committed
git status
# On branch main
# nothing to commit, working tree clean

# Hook runs on SessionEnd:
# â†’ [GIT-SAFETY] No uncommitted changes - nothing to save
# â†’ Exits gracefully
```

## Integration with Hooks

### Registered in `.claude/settings.json`

```json
{
  "SessionEnd": [
    {
      "_comment": "Git Safety: auto-commit uncommitted changes to safety branch",
      "hooks": [
        {
          "type": "command",
          "command": "node .claude/hooks/session-end-git-safety.js",
          "_note": "Auto-saves uncommitted changes to timestamped branch if session > 2.5h"
        }
      ]
    },
    {
      "_comment": "Vibe-log: capture on session end",
      "hooks": [...]
    }
  ]
}
```

### Execution Order
1. **Git Safety** â†’ Saves uncommitted work (if needed)
2. **Vibe-log** â†’ Captures session analytics

## Limitations

### What It Doesn't Do
- âŒ Does NOT push to remote (local safety only)
- âŒ Does NOT run periodically (only on SessionEnd)
- âŒ Does NOT merge branches automatically (manual review required)
- âŒ Does NOT work if Claude Code crashes (session never ends)

### Future Enhancements (Roadmap)
- [ ] Periodic warning hook (every hour without commit)
- [ ] Auto-push to remote safety branch (opt-in)
- [ ] Smart merge (auto-merge if no conflicts)
- [ ] Integration with Claude Code status bar
- [ ] Email/Slack notification on auto-save

## Troubleshooting

### Hook Doesn't Run

**Check hook registration:**
```bash
cat .claude/settings.json | grep -A 10 SessionEnd
```

**Check hook is executable:**
```bash
ls -l .claude/hooks/session-end-git-safety.js
# Should show: -rwxr-xr-x (executable bit set)
```

**Test manually:**
```bash
node .claude/hooks/session-end-git-safety.js
```

### Hook Runs But No Branch Created

**Check threshold:**
```bash
# Hook only triggers if session > 2.5h
# Check elapsed time:
echo "scale=2; ($(date +%s) - $(git log -1 --format=%ct)) / 3600" | bc
```

**Check for uncommitted changes:**
```bash
git status --porcelain
# Should show output if there are changes
```

**Check logs:**
```bash
# Hook logs to stderr, check terminal output on session end
```

### Safety Branch Cluttering Repo

**Clean up old branches:**
```bash
# List all auto-save branches:
git branch --list "auto-save/*"

# Delete specific branch:
git branch -d auto-save/session-2025-11-17T22-18-18

# Delete all auto-save branches (CAREFUL!):
git branch --list "auto-save/*" | xargs git branch -D

# Or keep only recent ones (last 7 days):
for branch in $(git branch --list "auto-save/*" | sed 's/*//' | xargs); do
  timestamp=$(git log $branch -1 --format=%ct)
  age_days=$(echo "scale=0; ($(date +%s) - $timestamp) / 86400" | bc)
  if [ $age_days -gt 7 ]; then
    echo "Deleting old branch: $branch (${age_days}d old)"
    git branch -D $branch
  fi
done
```

## Testing

### Test Suite

```bash
# Test 1: Clean repo (no changes)
git status  # Ensure clean
node .claude/hooks/session-end-git-safety.js
# Expected: "No uncommitted changes - nothing to save"

# Test 2: Uncommitted changes, short session (< 2.5h)
echo "test" > test-file.txt
node .claude/hooks/session-end-git-safety.js
# Expected: "Below threshold (2.5h) - skipping auto-save"
rm test-file.txt

# Test 3: Uncommitted changes, long session (simulated)
echo "test" > test-file.txt
GIT_SAFETY_THRESHOLD_HOURS=0.1 node .claude/hooks/session-end-git-safety.js
# Expected: Creates auto-save/session-{timestamp} branch
git branch --list "auto-save/*"  # Verify branch created
git status  # Verify main is clean
git branch -D auto-save/*  # Cleanup

# Test 4: Merge conflict state (unsafe)
git merge --no-commit some-other-branch  # Create conflict
node .claude/hooks/session-end-git-safety.js
# Expected: "Repository in merge/rebase state - skipping for safety"
git merge --abort  # Cleanup
```

## Architecture

### File Structure
```
.claude/hooks/
â”œâ”€â”€ session-end-git-safety.js    # Main hook (this file)
â”œâ”€â”€ legal-braniac-session.json   # Session tracking (created by SessionStart)
â””â”€â”€ GIT-SAFETY-HOOK.md          # This documentation
```

### Dependencies
- Node.js (built-in modules: `child_process`, `fs`, `path`)
- Git (must be in PATH)
- Legal-braniac session tracking (for accurate time measurement)

### Code Quality
- âœ… Error handling for all git operations
- âœ… Safe fallbacks (session time â†’ last commit time)
- âœ… Detailed logging to stderr
- âœ… Non-blocking on errors (doesn't prevent session end)
- âœ… Idempotent (can run multiple times safely)

## Contributing

### Adding New Features

1. **Fork and modify** `.claude/hooks/session-end-git-safety.js`
2. **Test thoroughly** with test suite above
3. **Update this documentation**
4. **Commit with conventional format**: `feat(git-safety): add feature X`

### Reporting Issues

Include:
- Git status output
- Session duration (from statusline or `legal-braniac-session.json`)
- Hook logs (stderr output)
- Expected vs actual behavior

## License

MIT - Same as Claude-Code-Projetos

---

**Maintained by:** PedroGiudice
**Created with:** Claude Code (session-end-git-safety meta-usecase)
**Last updated:** 2025-11-17
