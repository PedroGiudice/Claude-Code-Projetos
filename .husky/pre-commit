#!/bin/sh
# Pre-commit hook for Legal Workbench monorepo
# 1. Block direct commits to main/master
# 2. Run lint/format only on staged frontend files
export PATH="$HOME/.bun/bin:/usr/bin:/snap/bin:$PATH"

# === BRANCH PROTECTION ===
BRANCH=$(git branch --show-current)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    echo ""
    echo "BLOQUEADO: Commits diretos na branch '$BRANCH' nao sao permitidos."
    echo ""
    echo "O que fazer:"
    echo "  1. Crie uma branch: git checkout -b work/sua-feature"
    echo "  2. Faca seus commits na nova branch"
    echo "  3. Merge via PR ou: git checkout main && git merge work/sua-feature"
    echo ""
    echo "Para bypass (emergencia): git commit --no-verify"
    echo ""
    exit 1
fi

# Get list of staged TS/TSX files in frontend
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'legal-workbench/frontend/.*\.(ts|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "Running lint check on staged frontend files..."
    cd legal-workbench/frontend
    echo "$STAGED_FILES" | sed 's|legal-workbench/frontend/||g' | xargs -r bunx eslint --fix --quiet
    echo "$STAGED_FILES" | sed 's|legal-workbench/frontend/||g' | xargs -r bunx prettier --write
    cd - > /dev/null
    git add $STAGED_FILES
fi
